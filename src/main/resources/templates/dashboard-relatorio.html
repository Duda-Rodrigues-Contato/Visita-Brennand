<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Viva - Relatório</title>
    <link rel="icon" th:href="@{/img/1.png}" type="image/x-icon" />
    <link rel="stylesheet" th:href="@{/css/dashboard-relatorio.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
        <header class="header">
        <div class="header__container">
            <a href="/status-parque" class="brand">
                <img th:src="@{../img/1.png}" alt="Logo Gestão Viva" class="brand__logo" />
                <span>Gestão Viva</span>
            </a>
            <nav class="nav">
                <a href="/status-parque" class="nav-link">Início</a>
                <a href="/agendamento" class="nav-link ">Agendamento</a>
                <a th:href="@{/dashboard/avaliacoes}" class="nav-link">Avaliações</a>
                <a href="/dashboard" class="nav-link active">Dashboard</a>
            </nav>
        </div>
    </header>
<div class="main-container">
        <main>
            <section class="card filter-card">
                <h2>Relatório por Período</h2>
                <form th:action="@{/dashboard}" method="get" class="filter-form">
                    <input type="hidden" name="page" th:value="${paginaDeVisitas.number}" />
                    <input type="hidden" name="sort" th:value="${sort}" />
                    <div class="date-inputs">
                        <div class="form-group">
                            <label for="dataInicio">Data de Início</label>
                            <input type="date" id="dataInicio" name="dataInicio" th:value="${#temporals.format(dataInicio, 'yyyy-MM-dd')}">
                        </div>
                        <div class="form-group">
                            <label for="dataFim">Data de Fim</label>
                            <input type="date" id="dataFim" name="dataFim" th:value="${#temporals.format(dataFim, 'yyyy-MM-dd')}">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                        <a th:href="@{/dashboard}" class="btn btn-secondary">Limpar Filtros</a>
                    </div>
                </form>
            </section>

            <section class="metrics-grid">
                 <div class="card metric-card">
                    <h3>Total de Visitas no Período</h3>
                    <p class="metric-value" th:text="${totalVisitas}">0</p>
                </div>
                <div class="card metric-card">
                    <h3>Visitas Concluídas</h3>
                    <p class="metric-value" th:text="${visitasConcluidas}">0</p>
                </div>
                 <div class="card metric-card">
                    <h3>Média Diária de Visitantes</h3>
                    <p class="metric-value" th:text="${mediaVisitantes}">0</p>
                </div>
            </section>

            <section class="card">
                <h2>Gráfico de Visitantes por Período</h2>
                <div class="chart-container">
                    <canvas id="visitantesChart"></canvas>
                </div>
            </section>


            <section class="card">
                <h2>Detalhes dos Agendamentos no Período</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>
                                    <a th:href="@{/dashboard(
                                        dataInicio=${#temporals.format(dataInicio, 'yyyy-MM-dd')},
                                        dataFim=${#temporals.format(dataFim, 'yyyy-MM-dd')},
                                        size=${size},
                                        page=0,
                                        sort=${sort == 'dataVisita,ASC' ? 'dataVisita,desc' : 'dataVisita,asc'}
                                    )}" style="color: var(--vermelho-destaque); text-decoration: none;">
                                        Data da Visita
                                        <span th:if="${sort == 'dataVisita,ASC'}">▲</span>
                                        <span th:if="${sort == 'dataVisita,DESC'}">▼</span>
                                    </a>
                                </th>
                                <th>Nome do Grupo/Instituição</th>
                                <th>Responsável</th>
                                <th>Nº de Visitantes</th>
                                <th>Status</th>
                                <th>Acessibilidade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="visita : ${paginaDeVisitas.content}">
                                <td th:text="${#temporals.format(visita.dataVisita, 'dd/MM/yyyy')}">dd/mm/aaaa</td>
                                <td th:text="${visita.nomeInstituicao}">Escola Municipal ...</td>
                                <td th:text="${visita.nomeResponsavel}">Maria Soares</td>
                                <td th:text="${visita.numeroVisitantes}">45</td>
                                <td>
                                    <span class="status" th:classappend="${'status-' + #strings.toLowerCase(visita.status)}" th:text="${visita.status}">STATUS</span>
                                </td>
                                <td th:text="${visita.incluiPcd ? 'Sim' : 'Não'}">Sim</td>
                            </tr>
                            <tr th:if="${paginaDeVisitas.empty}">
                                <td colspan="6" class="empty-message">Nenhum agendamento encontrado para o período selecionado.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" th:if="${paginaDeVisitas.totalPages > 1}">
                    <a th:if="${!paginaDeVisitas.first}"
                       th:href="@{/dashboard(
                           dataInicio=${#temporals.format(dataInicio, 'yyyy-MM-dd')}, 
                           dataFim=${#temporals.format(dataFim, 'yyyy-MM-dd')}, 
                           page=${paginaDeVisitas.number - 1},
                           size=${size},
                           sort=${sort}
                       )}"
                       class="btn btn-secondary">Anterior</a>
                    <span th:if="${paginaDeVisitas.first}"></span>

                    <span class="page-info">
                        Página <span th:text="${paginaDeVisitas.number + 1}">1</span> de <span th:text="${paginaDeVisitas.totalPages}">3</span>
                    </span>
                    
                    <a th:if="${!paginaDeVisitas.last}"
                       th:href="@{/dashboard(
                           dataInicio=${#temporals.format(dataInicio, 'yyyy-MM-dd')}, 
                           dataFim=${#temporals.format(dataFim, 'yyyy-MM-dd')}, 
                           page=${paginaDeVisitas.number + 1},
                           size=${size},
                           sort=${sort}
                       )}"
                       class="btn btn-secondary">Próximo</a>
                    <span th:if="${paginaDeVisitas.last}"></span>

                    <form th:action="@{/dashboard}" method="get" class="page-size-form">
                        <input type="hidden" name="dataInicio" th:value="${#temporals.format(dataInicio, 'yyyy-MM-dd')}">
                        <input type="hidden" name="dataFim" th:value="${#temporals.format(dataFim, 'yyyy-MM-dd')}">
                        <input type="hidden" name="sort" th:value="${sort}">
                        <input type="hidden" name="page" value="0"> <label for="size">Itens por pág:</label>
                        <select id="size" name="size" onchange="this.form.submit()">
                            <option value="5" th:selected="${size == 5}">5</option>
                            <option value="10" th:selected="${size == 10}">10</option>
                            <option value="20" th:selected="${size == 20}">20</option>
                            <option value="50" th:selected="${size == 50}">50</option>
                        </select>
                    </form>
                </div>
            </section>
        </main>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const labelsDoGrafico = /*[[${chartLabels}]]*/ [];
    const dadosDoGrafico = /*[[${chartData}]]*/ [];
    /*]]>*/
</script>

<script th:src="@{/js/dashboard-chart.js}"></script>
</body>
</html>